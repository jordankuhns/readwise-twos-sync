<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - Readwise Twos Sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .admin-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .user-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-admin {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }
        
        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
        }
        
        .btn-danger-admin {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            color: white;
            border-radius: 10px;
            padding: 0.5rem 1rem;
        }
        
        .admin-header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }
        
        .admin-header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .admin-header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .stats-card {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        
        .modal-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px 15px 0 0;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="bi bi-shield-lock"></i> Admin Console</h1>
            <p>Manage users and system settings</p>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-number" id="total-users">-</div>
                    <div>Total Users</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-number" id="active-users">-</div>
                    <div>Active Users</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <div class="stats-number" id="recent-logins">-</div>
                    <div>Recent Logins</div>
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div class="admin-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="bi bi-people"></i> User Management</h3>
                <button class="btn btn-admin" data-bs-toggle="modal" data-bs-target="#createUserModal">
                    <i class="bi bi-person-plus"></i> Create User
                </button>
            </div>

            <div class="user-table">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Provider</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr>
                            <td colspan="6" class="text-center">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="admin-card">
            <h3><i class="bi bi-lightning"></i> Quick Actions</h3>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-admin w-100 mb-2" onclick="refreshUsers()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Users
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-admin w-100 mb-2" onclick="exportUsers()">
                        <i class="bi bi-download"></i> Export Users
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-plus"></i> Create New User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-user-form">
                        <div class="mb-3">
                            <label for="new-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="new-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="new-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="new-password" required minlength="6">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-admin" onclick="createUser()">Create User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-key"></i> Reset Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Reset password for: <strong id="reset-user-email"></strong></p>
                    <form id="reset-password-form">
                        <div class="mb-3">
                            <label for="reset-new-password" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="reset-new-password" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label for="reset-confirm-password" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="reset-confirm-password" required minlength="6">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-admin" onclick="resetUserPassword()">Reset Password</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = window.location.origin;
        let currentResetUserId = null;

        // Load users on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            loadStats();
        });

        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/api/admin/users`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token') || 'admin-access'}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load users');
                }

                const users = await response.json();
                displayUsers(users);
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-table-body').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Failed to load users</td></tr>';
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.email}</td>
                    <td>${user.name || 'N/A'}</td>
                    <td><span class="badge bg-primary">${user.auth_provider}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-admin me-1" onclick="openResetPassword(${user.id}, '${user.email}')">
                            <i class="bi bi-key"></i> Reset
                        </button>
                        <button class="btn btn-sm btn-danger-admin" onclick="deleteUser(${user.id}, '${user.email}')">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/api/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token') || 'admin-access'}`
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('total-users').textContent = stats.total_users || 0;
                    document.getElementById('active-users').textContent = stats.active_users || 0;
                    document.getElementById('recent-logins').textContent = stats.recent_logins || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function createUser() {
            const email = document.getElementById('new-email').value;
            const name = document.getElementById('new-name').value;
            const password = document.getElementById('new-password').value;

            if (!email || !name || !password) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('admin_token') || 'admin-access'}`
                    },
                    body: JSON.stringify({ email, name, password })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('User created successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                    document.getElementById('create-user-form').reset();
                    loadUsers();
                    loadStats();
                } else {
                    alert(data.error || 'Failed to create user');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Failed to create user');
            }
        }

        function openResetPassword(userId, email) {
            currentResetUserId = userId;
            document.getElementById('reset-user-email').textContent = email;
            document.getElementById('reset-password-form').reset();
            new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
        }

        async function resetUserPassword() {
            const newPassword = document.getElementById('reset-new-password').value;
            const confirmPassword = document.getElementById('reset-confirm-password').value;

            if (!newPassword || !confirmPassword) {
                alert('Please fill in both password fields');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/users/${currentResetUserId}/reset-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('admin_token') || 'admin-access'}`
                    },
                    body: JSON.stringify({ password: newPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Password reset successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
                    loadUsers();
                } else {
                    alert(data.error || 'Failed to reset password');
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                alert('Failed to reset password');
            }
        }

        async function deleteUser(userId, email) {
            if (!confirm(`Are you sure you want to delete user: ${email}?\n\nThis action cannot be undone!`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token') || 'admin-access'}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('User deleted successfully!');
                    loadUsers();
                    loadStats();
                } else {
                    alert(data.error || 'Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Failed to delete user');
            }
        }

        function refreshUsers() {
            loadUsers();
            loadStats();
        }

        function exportUsers() {
            // Simple CSV export
            const table = document.querySelector('.user-table table');
            let csv = [];
            
            // Get headers
            const headers = Array.from(table.querySelectorAll('thead th')).slice(0, -1).map(th => th.textContent);
            csv.push(headers.join(','));
            
            // Get data rows
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).slice(0, -1).map(td => td.textContent);
                csv.push(cells.join(','));
            });
            
            // Download CSV
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'users.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>